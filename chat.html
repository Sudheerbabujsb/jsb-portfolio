<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Just Us ðŸ’š</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
.hidden{display:none}
.dark{background:#0b141a}

.header{
  background:#075e54;color:white;padding:12px;
  display:flex;justify-content:space-between;align-items:center
}
.dark .header{background:#1f2c34}
#status{font-size:12px;opacity:.85}

#loginBox{
  max-width:360px;margin:60px auto;background:white;
  padding:20px;border-radius:8px
}
.dark #loginBox{background:#1f2c34;color:white}

input,button{
  width:100%;padding:10px;margin-top:8px;
  border-radius:5px;border:1px solid #ccc
}
button{background:#25d366;color:white;border:none}

#chat{height:100vh}
#messages{
  height:calc(100vh - 190px);
  overflow-y:auto;padding:10px
}

.msg{
  max-width:75%;padding:8px;margin-bottom:6px;
  border-radius:8px;position:relative
}
.me{margin-left:auto;background:#dcf8c6;border-radius:8px 0 8px 8px}
.her{background:white;border-radius:0 8px 8px 8px}
.dark .me{background:#005c4b;color:white}
.dark .her{background:#202c33;color:white}

.time{font-size:10px;text-align:right;color:#555}
.actions{
  font-size:11px;color:#666;
  display:flex;gap:10px;justify-content:flex-end
}
.actions span{cursor:pointer}

#typing{padding-left:12px;font-size:12px;color:#666}

.footer{
  display:flex;padding:8px;background:#f0f0f0
}
.dark .footer{background:#1f2c34}
#msg{flex:1;padding:10px;border-radius:20px}
.sendBtn{
  width:45px;height:45px;border-radius:50%;
  margin-left:6px;font-size:18px
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h3 align="center">Private Chat ðŸ’š</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password">
  <button onclick="login()">Login</button>
</div>

<!-- CHAT -->
<div id="chat" class="hidden">
  <div class="header">
    <div>
      Just Us ðŸ’š
      <div id="status">offline</div>
    </div>
    <button onclick="toggleDark()">ðŸŒ™</button>
  </div>

  <div id="messages"></div>
  <div id="typing"></div>

  <div class="footer">
    <input id="msg" placeholder="Type a message">
    <button class="sendBtn" onclick="send()">âž¤</button>
  </div>
</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  push,
  update,
  remove,
  set,
  onValue,
  onChildAdded,
  onChildChanged,
  onChildRemoved,
  onDisconnect
} from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBd14pfFYZVkAIDHumbRwo4qP79QRz0Os0",
  authDomain: "jss1207.firebaseapp.com",
  databaseURL: "https://jss1207-default-rtdb.firebaseio.com",
  projectId: "jss1207"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* FORCE LOGOUT ON REFRESH */
signOut(auth);

/* LOGIN */
window.login = ()=>{
  signInWithEmailAndPassword(auth,email.value,password.value)
  .catch(()=>alert("Wrong login"));
};

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    loginBox.classList.remove("hidden");
    chat.classList.add("hidden");
    return;
  }

  loginBox.classList.add("hidden");
  chat.classList.remove("hidden");
  messages.innerHTML="";

  const uid = auth.currentUser.uid;

  /* ðŸ”µ PRESENCE (CORRECT) */
  const myRef = ref(db,"users/"+uid);
  set(myRef,{online:true,lastSeen:Date.now()});
  onDisconnect(myRef).set({online:false,lastSeen:Date.now()});

  onValue(ref(db,"users"),snap=>{
    snap.forEach(u=>{
      if(u.key!==uid){
        const v=u.val();
        status.innerText = v.online
          ? "online"
          : "last seen " + new Date(v.lastSeen).toLocaleTimeString();
      }
    });
  });

  const msgRef = ref(db,"messages");

  /* âž• ADD */
  onChildAdded(msgRef,snap=>{
    renderMessage(snap.key,snap.val());
  });

  /* âœï¸ EDIT */
  onChildChanged(msgRef,snap=>{
    const el=document.getElementById("m-"+snap.key);
    if(el){
      el.querySelector(".text").innerText = snap.val().text;
    }
  });

  /* ðŸ—‘ DELETE */
  onChildRemoved(msgRef,snap=>{
    const el=document.getElementById("m-"+snap.key);
    if(el) el.remove();
  });

  function renderMessage(id,m){
    const div=document.createElement("div");
    div.className="msg "+(m.uid===uid?"me":"her");
    div.id="m-"+id;

    div.innerHTML=`
      <div class="text">${m.text}</div>
      <div class="time">
        ${new Date(m.time).toLocaleTimeString([],{
          hour:'2-digit',minute:'2-digit'
        })}
        ${m.uid===uid?(m.seen?" âœ“âœ“":" âœ“"):""}
      </div>
      ${m.uid===uid?`
        <div class="actions">
          <span onclick="editMsg('${id}')">edit</span>
          <span onclick="delMsg('${id}')">delete</span>
        </div>`:""}
    `;
    messages.appendChild(div);
    messages.scrollTop=messages.scrollHeight;

    if(m.uid!==uid && !m.seen){
      update(ref(db,"messages/"+id),{seen:true});
    }
  }
});

/* SEND */
window.send=()=>{
  if(!msg.value.trim())return;
  push(ref(db,"messages"),{
    text:msg.value,
    uid:auth.currentUser.uid,
    time:Date.now(),
    seen:false
  });
  msg.value="";
};

/* EDIT */
window.editMsg=(id)=>{
  const el=document.querySelector("#m-"+id+" .text");
  const newText=prompt("Edit message",el.innerText);
  if(newText!==null)
    update(ref(db,"messages/"+id),{text:newText});
};

/* DELETE */
window.delMsg=(id)=>{
  if(confirm("Delete this message?"))
    remove(ref(db,"messages/"+id));
};

/* TYPING */
msg.oninput=()=>{
  set(ref(db,"typing"),auth.currentUser.uid);
  setTimeout(()=>remove(ref(db,"typing")),1200);
};
onValue(ref(db,"typing"),snap=>{
  typing.innerText =
    snap.exists() && snap.val()!==auth.currentUser.uid
    ? "Typing..."
    : "";
});

/* DARK MODE */
window.toggleDark=()=>{
  document.body.classList.toggle("dark");
};
</script>

</body>
</html>