<!DOCTYPE html>
<html>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#075e54">
<head>
<meta charset="UTF-8">
<title>Just Us ğŸ’š</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#ece5dd}
.hidden{display:none}
.dark{background:#0b141a}

.header{
  background:#075e54;color:white;padding:12px;
  display:flex;justify-content:space-between;align-items:center
}
.dark .header{background:#1f2c34}

#loginBox{
  max-width:320px;margin:80px auto;background:white;
  padding:20px;border-radius:8px;text-align:center
}
.dark #loginBox{background:#1f2c34;color:white}

input,button{
  width:100%;padding:12px;margin-top:10px;
  border-radius:6px;border:1px solid #ccc;font-size:16px
}
button{background:#25d366;color:white;border:none}

#chat{height:100vh}
#messages{
  height:calc(100vh - 160px);
  overflow-y:auto;padding:10px
}

.msg{
  max-width:75%;padding:8px;margin-bottom:6px;
  border-radius:8px;user-select:none
}
.me{margin-left:auto;background:#dcf8c6;border-radius:8px 0 8px 8px}
.her{background:white;border-radius:0 8px 8px 8px}
.dark .me{background:#005c4b;color:white}
.dark .her{background:#202c33;color:white}

.time{font-size:10px;text-align:right;color:#555}
.edited{font-size:10px;color:#777;font-style:italic;margin-left:4px}
.deleted{font-style:italic;color:#777}

.footer{
  display:flex;padding:8px;background:#f0f0f0
}
.dark .footer{background:#1f2c34}
#msg{flex:1;padding:10px;border-radius:20px}
.sendBtn{width:45px;height:45px;border-radius:50%;margin-left:6px}

/* CONTEXT MENU */
#menu{
  position:fixed;background:white;border-radius:6px;
  box-shadow:0 2px 10px rgba(0,0,0,.3);
  display:none;z-index:999
}
#menu div{
  padding:12px 16px;cursor:pointer;
  border-bottom:1px solid #eee
}
#menu div:last-child{border-bottom:none}
#menu div:hover{background:#f0f0f0}
.dark #menu{background:#1f2c34;color:white}
.dark #menu div:hover{background:#333}
</style>
</head>

<body>

<!-- PIN LOGIN -->
<div id="loginBox">
  <h3>Enter PIN ğŸ”</h3>
  <input id="pin" type="password" placeholder="Enter PIN">
  <button onclick="pinLogin()">Unlock</button>
</div>

<!-- CHAT -->
<div id="chat" class="hidden">
  <div class="header">
    <div>Just Us ğŸ’š</div>
    <button onclick="toggleDark()">ğŸŒ™</button>
  </div>

  <div id="messages"></div>

  <div class="footer">
    <input id="msg" placeholder="Type a message">
    <button class="sendBtn" onclick="send()">â¤</button>
  </div>
</div>

<!-- LONG PRESS MENU -->
<div id="menu">
  <div id="editBtn" onclick="editSelected()">âœï¸ Edit</div>
  <div onclick="deleteForMe()">ğŸ—‘ Delete for me</div>
  <div id="delAllBtn" onclick="deleteForAll()">ğŸš« Delete for everyone</div>
</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  push,
  update,
  onChildAdded,
  onChildChanged
} from
"https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBd14pfFYZVkAIDHumbRwo4qP79QRz0Os0",
  authDomain: "jss1207.firebaseapp.com",
  databaseURL: "https://jss1207-default-rtdb.firebaseio.com",
  projectId: "jss1207"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* FORCE LOGIN */
signOut(auth);

/* PIN MAP */
const PIN_MAP = {
  "120700": { email: "Shyni@jsudheerbabu.in", password: "Sudheer@Shyni" },
  "021104": { email: "Sudheer@jsudheerbabu.in", password: "Shyni@Sudheer" }
};

/* DELETE FOR ME (PERSISTENT) */
const HIDDEN_KEY="hiddenMessages";
const getHidden=()=>JSON.parse(localStorage.getItem(HIDDEN_KEY)||"[]");
const saveHidden=a=>localStorage.setItem(HIDDEN_KEY,JSON.stringify(a));

window.pinLogin=()=>{
  const p=pin.value.trim();
  if(!PIN_MAP[p]) return alert("Wrong PIN");
  signInWithEmailAndPassword(auth,PIN_MAP[p].email,PIN_MAP[p].password);
};

/* MENU STATE */
let selectedMsgId=null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    loginBox.classList.remove("hidden");
    chat.classList.add("hidden");
    return;
  }

  loginBox.classList.add("hidden");
  chat.classList.remove("hidden");
  messages.innerHTML="";

  const uid=user.uid;
  const msgRef=ref(db,"messages");

  onChildAdded(msgRef,s=>render(s.key,s.val()));
  onChildChanged(msgRef,s=>render(s.key,s.val()));

  function render(id,m){
    if(getHidden().includes(id)) return;

    let el=document.getElementById("m-"+id);
    if(!el){
      el=document.createElement("div");
      el.id="m-"+id;
      el.className="msg "+(m.uid===uid?"me":"her");

      el.oncontextmenu=e=>openMenu(e,id);
      let t;
      el.ontouchstart=e=>t=setTimeout(()=>openMenu(e,id),600);
      el.ontouchend=()=>clearTimeout(t);

      messages.appendChild(el);
    }

    /* ğŸ”‘ STORE LIVE STATE ON DOM */
    el.dataset.uid = m.uid;
    el.dataset.time = m.time;
    el.dataset.deleted = m.deleted ? "1" : "0";

    el.innerHTML = m.deleted
      ? `<div class="deleted">This message was deleted</div>`
      : `
        <div class="text">${m.text}</div>
        <div class="time">
          ${new Date(m.time).toLocaleTimeString([],{
            hour:'2-digit',minute:'2-digit'
          })}
          ${m.edited?`<span class="edited">(edited)</span>`:""}
          ${m.uid===uid?(m.seen?" âœ“âœ“":" âœ“"):""}
        </div>`;

    if(m.uid!==uid && !m.seen){
      update(ref(db,"messages/"+id),{seen:true});
    }

    messages.scrollTop=messages.scrollHeight;
  }
});

/* SEND */
window.send=()=>{
  if(!msg.value.trim())return;
  push(ref(db,"messages"),{
    text:msg.value,
    uid:auth.currentUser.uid,
    time:Date.now(),
    seen:false,
    edited:false,
    deleted:false
  });
  msg.value="";
};

/* MENU OPEN (FIXED) */
function openMenu(e,id){
  e.preventDefault();
  selectedMsgId=id;

  const el=document.getElementById("m-"+id);
  const isMine = el.dataset.uid === auth.currentUser.uid;
  const isDeleted = el.dataset.deleted === "1";
  const msgTime = Number(el.dataset.time);
  const within10 = Date.now()-msgTime <= 600000;

  /* âœ… CORRECT PERMISSION LOGIC */
  editBtn.style.display =
    (!isDeleted && isMine) ? "block" : "none";

  delAllBtn.style.display =
    (!isDeleted && isMine && within10) ? "block" : "none";

  menu.style.display="block";
  menu.style.top=e.clientY+"px";
  menu.style.left=e.clientX+"px";
}

/* ACTIONS */
window.editSelected=()=>{
  const el=document.getElementById("m-"+selectedMsgId);
  if(el.dataset.deleted==="1") return;

  const textEl=el.querySelector(".text");
  const t=prompt("Edit message",textEl.innerText);
  if(t!==null){
    update(ref(db,"messages/"+selectedMsgId),{
      text:t,edited:true
    });
  }
  closeMenu();
};

window.deleteForMe=()=>{
  const h=getHidden();
  if(!h.includes(selectedMsgId)){
    h.push(selectedMsgId);
    saveHidden(h);
  }
  const el=document.getElementById("m-"+selectedMsgId);
  if(el) el.remove();
  closeMenu();
};

window.deleteForAll=()=>{
  const el=document.getElementById("m-"+selectedMsgId);
  if(el.dataset.deleted==="1") return;

  if(Date.now()-Number(el.dataset.time)>600000){
    alert("Delete time expired");
    return;
  }
  update(ref(db,"messages/"+selectedMsgId),{
    text:"",deleted:true
  });
  closeMenu();
};

function closeMenu(){
  menu.style.display="none";
  selectedMsgId=null;
}

document.body.onclick=()=>closeMenu();

window.toggleDark=()=>{
  document.body.classList.toggle("dark");
};
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>